<?phpinclude_once "base_controller.php";Class BaseActionController extends BaseController {		var $applicationFolder;	var $article_options = array();	var $product_options = array();	var $current_member_information = array();	var $current_member_id;		function __construct() {		parent::__construct();				if ($this->enable_session) {		//启用session			@session_start();		}		$this->ci_smarty->assign('lang','chs'); //设置smarty语言				$this->initialize_member_login();				//initialize system message notices		$all_system_message_notice = $this->extend_control->getNewSystemMessageCategories($this->current_member_id);		//print_r($all_system_message_notice);exit();		$this->ci_smarty->assign('all_system_message_notice',$all_system_message_notice);	}		/**	* 检查用户登录	*/	function initialize_member_login(){		//print_r($_COOKIE);exit();		$cmid = $this->getSessionValue('current_member_id');				if( $cmid ) {			$this->current_member_id = $cmid;			$this->extend_control->setCurrentMemberInformation();		} elseif($_COOKIE['member_cookie']) {			//print_r($_COOKIE['member_cookie']);exit();			$this->db->select('member_id,password');			$this->db->from('member');			$this->db->where('account',$_COOKIE['member_cookie']['account']);			$login_information = $this->db->get_first();						if ( !$login_information ) redirect('welcome');			if ($_COOKIE['member_cookie']['key'] != md5($login_information['password'].$login_information['password']) )				redirect('welcome');			$this->extend_control->setCurrentMemberInformation();			redirect('index');		} else {			if(substr_count(current_url(),'welcome')==0&&strrchr(current_url(),"index.php")!="index.php"&&strrchr(current_url(),"index.php/")!="index.php/"){				redirect('welcome?ref='.rawurlencode(current_url()));			}else{				redirect('welcome');			}		}	}		/**	* 发送系统消息、更新首页动态	*	* @param 	$category 		大类：activity/blog/friend/message	* @param 	$type			消息类别（细类）	* @param 	$code			必要参数	* @param 	$target 		对方ID（可选）	*	*/	function newSystemMessage($category, $type, $code, $target=null) {		$data['created_time'] = $this->current_time;		$data['member_id'] = $this->current_member_id;		$data['target_id'] = $target;		$data['category']  = $category;		$data['type']      = $type;		$data['code']      = $code;		switch( $type ) {			//发布活动或写新书后通知全部好友			case 'new_activity':			case 'new_book':				$friend_list = $this->extend_control->getAllFriendsBasic( $this->current_member_id );								foreach ($friend_list as $i) {					$data['target_id'] = $i['member_id'];					$this->sendSystemMessage($data);				}				$this->sendToNewsFeed($data);				break;			//修改活动内容后通知所有attend member			case 'edit_activity':				$attend_list = $this->extend_control->getActivityAttendMemberId($data['code']);				foreach ($attend_list as $i) {					$data['target_id'] = $i['member_id'];					$this->sendSystemMessage($data);				}				$this->sendToNewsFeed($data);				break;			//活动、微型书新评论：通知发起人/作者			case 'new_comment':			//publisher回复评论：通知原作者			case 'new_reply':			//活动报名：通知publisher			case 'attend_activity':			//活动报名通过：通知用户			case 'attend_approve':			//好友申请			case 'apply_friend':			//好友申请通过			case 'approve_friend':				$this->sendSystemMessage($data);				$this->sendToNewsFeed($data);				break;			//邀请好友参加活动			case 'invite_attend_activity':				break;			//好友新留言			case 'new_message':				if( $this->checkMemberMessage($data) )					$this->db->insert('system_message',$data);				else {					$data['is_new']='Y';					$this->db->where('member_id',$data['member_id']);					$this->db->where('target_id',$data['target_id']);					$this->db->where('category',$data['category']);					$this->db->where('type',$data['type']);					$this->db->update('system_message',$data);				}				break;		} //end switch	}	function newNewsFeed($category, $type, $code) {		$data['created_time'] = $this->current_time;		$data['member_id'] = $this->current_member_id;		$data['target_id'] = 0;		$data['category']  = $category;		$data['type']      = $type;		$data['code']      = $code;		$this->sendToNewsFeed($data);	}		/**	* 发送系统消息最后检查	*/	function sendSystemMessage($data) {		if( $data['member_id'] == $data['target_id'] ) return false;		$this->db->insert('system_message',$data);	}	/**	* 同时抄送给首页	*/	function sendToNewsFeed($data) {		if( $data['member_id'] == $data['target_id'] ) return false;		if( $data['target_id'] == NULL ) $data['target_id'] = 0; //set dummy target		$this->db->insert('news_feed',$data);	}	/**	* 工具函数：检查是否存在相同的好友消息提醒	*	* @return 	false=有重复 	true=无重复	*/	function checkMemberMessage($check_data){		if($check_data['member_id'] == $check_data['target_id']) return false;		$this->db->where('member_id',$check_data['member_id']);		$this->db->where('target_id',$check_data['target_id']);		$this->db->where('category',$check_data['category']);		$this->db->where('type',$check_data['type']);		$count = $this->db->count_all_results('system_message');		return $count>0 ? false : true;	}	/**	* 工具函数：将系统信息解释为可显示文本	*	* @param 	Array 	data 	系统信息	*	* @return 	string 	message 	HTML消息文本	*/	function decodeMessage($data) {		if ( $data['category']=='activity' ) {			$activity_id = $data['code'];			$activity_name = idx( $this->extend_control->getActivityBasicById($activity_id), 'activity_name' );			switch( $data['type'] ) {				case 'new_activity':					$message = "<a href='".site_url("profile?id=".$data['member_id'])."'>".$data['member_name']."</a> 发起了活动 <a href='".site_url("activity/view?id=$activity_id")."'>$activity_name</a>";					break;				case 'edit_activity':					$message = "<a href='".site_url("profile?id=".$data['member_id'])."'>".$data['member_name']."</a> 修改了活动 <a href='".site_url("activity/view?id=$activity_id")."'>$activity_name</a> 的内容";					break;				case 'new_comment':					$message = "<a href='".site_url("profile?id=".$data['member_id'])."'>".$data['member_name']."</a> 评论了活动 <a href='".site_url("activity/view?id=$activity_id")."'>$activity_name</a> 的内容";					break;				case 'new_reply':					$message = "<a href='".site_url("profile?id=".$data['member_id'])."'>".$data['member_name']."</a> 回复了 <a href='".site_url("profile?id=".$data['target_id'])."'>". $data['target_name']."</a> 对活动 <a href=".site_url("activity/view?id=$activity_id")."'>$activity_name</a> 的评论";					break;				case 'attend_activity':					$message = "<a href='".site_url("profile?id=".$data['member_id'])."'>".$data['member_name']."</a> 报名参加了活动 <a href='".site_url("activity/view?id=$activity_id")."'>$activity_name</a>";					break;				case 'attend_approve':					$message = "<a href='".site_url("profile?id=".$data['member_id'])."'>".$data['member_name']."</a> 通过了 <a href='".site_url("profile?id=".$data['target_id'])."'>". $data['target_name']."</a> 对活动 <a href=".site_url("activity/view?id=$activity_id")."'>$activity_name</a> 的报名";					break;				case 'follow_activity':					$message = "<a href='".site_url("profile?id=".$data['member_id'])."'>".$data['member_name']."</a> 关注了活动 <a href='".site_url("activity/view?id=$activity_id")."'>$activity_name</a>";					break;				case 'rate_up':					$message = "<a href='".site_url("profile?id=".$data['member_id'])."'>".$data['member_name']."</a> 对活动 <a href='".site_url("activity/view?id=$activity_id")."'>$activity_name</a> 竖了大拇指";					break;				case 'rate_down':					$message = "<a href='".site_url("profile?id=".$data['member_id'])."'>".$data['member_name']."</a> 对活动 <a href='".site_url("activity/view?id=$activity_id")."'>$activity_name</a> 竖了小拇指";					break;			}		} elseif ( $data['category']=='book' ) {			$book_id = $data['code'];			$book_name = idx( $this->extend_control->getBookBasicById($book_id), 'book_name');			switch( $data['type'] ) {				case 'new_book':					$message = "<a href='".site_url("profile?id=".$data['member_id'])."'>".$data['member_name']."</a> 出版了微型书 <a href='".site_url("library/view?id=$book_id")."'>$book_name</a>";					break;				case 'edit_book':					$message = "<a href='".site_url("profile?id=".$data['member_id'])."'>".$data['member_name']."</a> 润色了微型书 <a href='".site_url("library/view?id=$book_id")."'>$book_name</a>的内容";					break;				case 'like_book':					$message = "<a href='".site_url("profile?id=".$data['member_id'])."'>".$data['member_name']."</a> 喜欢了微型书 <a href='".site_url("library/view?id=$book_id")."'>$book_name</a>";					break;				case 'new_comment':					$message = "<a href='".site_url("profile?id=".$data['member_id'])."'>".$data['member_name']."</a> 评论了微型书 <a href='".site_url("library/view?id=$book_id")."'>$book_name</a> 的内容";					break;			}		} elseif ( $data['category']=='friend' ) {			switch( $data['type'] ) {				case 'apply_friend':				$message = "<a href='".site_url("profile?id=".$data['member_id'])."'>".$data['member_name']."</a> 申请成为 <a href='".site_url("profile?id=".$data['target_id'])."'>".$data['target_name']."</a> 的好友";					break;				case 'approve_friend':					$message = "<a href='".site_url("profile?id=".$data['member_id'])."'>".$data['member_name']."</a> 与 <a href='".site_url("profile?id=".$data['target_id'])."'>".$data['target_name']."</a> 成为了好友";					break;			}		}		return $message;	}		/**	* 显示页面	*	* @author franklsf95	*	* @see BaseController::display()	*/	function display( $templateName, $templateTitle, $moreCss='', $moreJs='' ) {		$templateTitle .= ' | '.$this->current_member_information['member_name'];		parent::display( $templateName, $templateTitle, $moreCss, $moreJs, 'member' );	}}?>